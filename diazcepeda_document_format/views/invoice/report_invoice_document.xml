<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!--Informe-->
    <record id="account_invoices_copy" model="ir.actions.report">
        <field name="name">Factura Copia</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">diazcepeda_document_format.report_invoice_copy</field>
        <field name="report_file">diazcepeda_document_format.report_invoice_copy</field>
        <field name="print_report_name">(object._get_report_base_filename())</field>
        <field name="attachment"/>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
    </record>
    <!--Fin Informe -->
    <template id="report_invoice_copy">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-set="lang" t-value="o.partner_id.lang"/>
                <t t-set="is_copy" t-value="2"/>
                <t t-if="o._get_name_invoice_report() == 'account.report_invoice_document'"
                   t-call="account.report_invoice_document"
                   t-lang="lang"/>
            </t>
        </t>
    </template>

    <!-- Documento -->
    <template id="report_invoice_document_inherit" inherit_id="account.report_invoice_document">
        <xpath expr="//th[@name='th_priceunit']" position="replace">
            <th name="th_priceunit"
                t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                <span>Precio</span>
            </th>
        </xpath>

        <xpath expr="//td[@name='td_quantity']" position="replace">
            <td name="td_quantity" class="text-end">
                <span t-field="line.quantity">3</span>
            </td>
        </xpath>

        <xpath expr="//t[@t-set='lines']" position="replace">
            <t t-set="lines"
               t-value="o._get_invoice_lines_to_report(o.invoice_line_ids.sorted(key=lambda l: (-l.sequence, l.date, l.move_name, -l.id), reverse=True))"/>
        </xpath>

        <xpath expr="//div[@t-if='not is_html_empty(o.narration)']" position="after">
            <t t-set="show_gastos_gestion" t-value="o._is_gasto_gestion()"/>
            <t t-if="is_preprinted == 2">
                <t t-if="show_gastos_gestion">
                    <span>Este documento incluye 1 € de gastos de gestión.</span>
                </t>
            </t>
        </xpath>

        <xpath expr="//div[@name='comment']" position="after">
            <t t-if="o.amount_residual_signed == 0.00">
                <p style="font-weight:bolder;color:black;">*Esta factura está pagada.</p>
            </t>
            <t t-if="is_copy == 2">
                <p style="font-weight:bolder;color:black;">*Este documento es una copia.</p>
            </t>
        </xpath>


        <xpath expr="//table[@name='invoice_snln_table']" position="attributes">
            <attribute name="style">display: none;</attribute>
        </xpath>

        <xpath expr="//div[@name='origin']" position="replace">
            <t t-if="o.invoice_origin">
                <div t-attf-class="#{'col-auto col-3 mw-100' if report_type != 'html' else 'col'} mb-2"
                     t-if="',' not in o.invoice_origin" name="origin">
                    <strong>Origen:</strong>
                    <br/>
                    <span t-field="o.invoice_origin">SO123</span>
                </div>
            </t>
        </xpath>
        <xpath expr="//div[@id='right-elements']" position="before">
            <div id="left-elements"
                 t-attf-class="#{'col-5' if report_type != 'html' else 'col-12 col-md-5'} ms-5 d-inline-block float-start">
                <t t-set="footer_data" t-value="o._get_footer_data()"/>
                <div style="margin-left:-14%;">
                    <span t-raw="footer_data"/>
                </div>
            </div>
        </xpath>

        <xpath expr="//div[@name='address_not_same_as_shipping']/t[@t-set='address']/address" position="replace">
            <address class="mb-0" t-field="o.partner_id"
                     t-options='{"widget": "contact", "fields": ["address", "name", "phone"], "no_marker": True}'/>
        </xpath>

        <xpath expr="//div[@name='address_same_as_shipping']/t[@t-set='address']/address" position="replace">
            <address class="mb-0" t-field="o.partner_id"
                     t-options='{"widget": "contact", "fields": ["address", "name", "phone"], "no_marker": True}'/>
        </xpath>

        <xpath expr="//div[@name='no_shipping']/t[@t-set='address']/address" position="replace">
            <address class="mb-0" t-field="o.partner_id"
                     t-options='{"widget": "contact", "fields": ["address", "name", "phone"], "no_marker": True}'/>
        </xpath>

        <xpath expr="//tbody[@class='invoice_tbody']" position="replace">
            <tbody class="invoice_tbody">
                <t t-set="grouped_lines" t-value="{}"/>

                <!-- Recorrer todas las líneas de la factura -->
                <t t-foreach="o.invoice_line_ids" t-as="line">
                    <!-- Verificar si el campo invoice_origin no está vacío -->
                    <t t-if="line.move_id.invoice_origin">
                        <!-- Separar los orígenes (si existen más de uno) -->
                        <t t-set="origins" t-value="line.move_id.invoice_origin.split(', ')"/>

                        <!-- Recorrer cada origen y agrupar las líneas -->
                        <t t-foreach="origins" t-as="origin">
                            <!-- Verificar si la línea tiene un origen específico -->
                            <t t-if="origin">
                                <!-- Si el origen no está en grouped_lines, agregarlo como nueva clave -->
                                <t t-if="origin not in grouped_lines">
                                    <t t-set="grouped_lines" t-value="dict(grouped_lines, **{origin: [line]})"/>
                                </t>
                                <!-- Si ya existe el origen, agregar la línea al grupo correspondiente -->
                                <t t-else="">
                                    <t t-set="grouped_lines"
                                       t-value="dict(grouped_lines, **{origin: grouped_lines[origin] + [line]})"/>
                                </t>
                            </t>
                        </t>
                    </t>
                </t>

                <!-- Ahora imprimimos los pedidos con sus líneas correspondientes -->
                <t t-foreach="grouped_lines.items()" t-as="group">
                    <tr>
                        <td colspan="6">
                            <strong>Pedido:
                                <t t-esc="group[0]"/>
                            </strong>
                        </td>
                    </tr>

                    <!-- Mostrar solo las líneas correspondientes a este pedido -->
                    <t t-foreach="group[1]" t-as="line">
                        <tr t-att-class="'bg-200 fw-bold o_line_section' if line.display_type == 'line_section' else 'fst-italic o_line_note' if line.display_type == 'line_note' else ''">
                            <t t-if="line.display_type == 'product'" name="account_invoice_line_accountable">
                                <td name="account_invoice_line_name">
                                    <span t-if="line.name" t-field="line.name" t-options="{'widget': 'text'}"/>
                                </td>
                                <td name="td_quantity" class="text-end">
                                    <span t-field="line.quantity"/>
                                </td>
                                <td name="td_price_unit"
                                    t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                    <span class="text-nowrap" t-field="line.price_unit"/>
                                </td>
                                <td name="td_discount" t-if="display_discount"
                                    t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                    <span class="text-nowrap" t-field="line.discount"/>
                                </td>
                                <t t-set="taxes"
                                   t-value="', '.join([(tax.invoice_label or tax.name) for tax in line.tax_ids])"/>
                                <td name="td_taxes"
                                    t-attf-class="{{ 'd-none d-md-table-cell' if report_type == 'html' else '' }} {{ 'text-nowrap' if len(taxes) &lt; 10 else '' }}">
                                    <span t-out="taxes" id="line_tax_ids"/>
                                </td>
                                <td name="td_subtotal" class="text-end o_price_total">
                                    <span class="text-nowrap" t-field="line.price_subtotal"/>
                                </td>
                            </t>
                            <t t-elif="line.display_type == 'line_section'">
                                <td colspan="99">
                                    <span t-field="line.name" t-options="{'widget': 'text'}"/>
                                </td>
                            </t>
                            <t t-elif="line.display_type == 'line_note'">
                                <td colspan="99">
                                    <span t-field="line.name" t-options="{'widget': 'text'}"/>
                                </td>
                            </t>
                        </tr>
                    </t>
                </t>
            </tbody>
        </xpath>

        <xpath expr="//td[@name='account_invoice_line_name']" position="inside">
            <br/>
            <span>
                <i>• Lote</i>
            </span>
            <t t-set="lot_values" t-value="o._get_invoiced_lot_values()"/>
            <t t-foreach="lot_values" t-as="snln_line">
                <t t-if="line.name == snln_line['product_name']">
                    <span>
                        <i>
                            <t t-esc="snln_line['lot_name']"/>
                        </i>
                    </span>
                    <span>(</span>
                    <span>
                        <i>
                            <t t-esc="snln_line['quantity']"/>
                        </i>
                    </span>
                    <span>)</span>
                </t>
            </t>
        </xpath>
    </template>
</odoo>
